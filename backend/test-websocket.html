<!DOCTYPE html>
<html>

<head>
    <title>STOMP WebSocket Test - Through Gateway</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        #logs {
            border: 1px solid #ccc;
            padding: 10px;
            height: 400px;
            overflow-y: scroll;
            background: #f5f5f5;
            margin: 20px 0;
        }

        .log {
            margin: 5px 0;
            padding: 5px;
        }

        .success {
            color: green;
        }

        .error {
            color: red;
        }

        .info {
            color: blue;
        }

        input,
        button {
            padding: 8px;
            margin: 5px;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background: #45a049;
        }

        .warning {
            background: #d4edda;
            padding: 10px;
            border: 1px solid #28a745;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <h1>ðŸ”Œ STOMP WebSocket Test</h1>
    <div class="warning">
        <strong>âœ… TESTING:</strong> Connecting through API Gateway on port 8080
    </div>
    <div><strong>Status:</strong> <span id="status">Disconnected</span></div>
    <div id="logs"></div>
    <div>
        <input type="text" id="roomId" placeholder="Enter Room ID" value="test-room-123">
        <button onclick="subscribeToRoom()">Subscribe to Room</button>
    </div>
    <div>
        <input type="text" id="message" placeholder="Enter message" value="Hello through Gateway!">
        <button onclick="sendMessage()">Send Message</button>
    </div>

    <script>
        let stompClient = null;
        let currentSubscription = null;
        const logsDiv = document.getElementById('logs');
        const statusDiv = document.getElementById('status');

        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.textContent = `[${time}] ${message}`;
            logsDiv.appendChild(logDiv);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        function connect() {
            log('ðŸ”Œ Connecting through API Gateway on port 8080...', 'info');
            statusDiv.textContent = 'Connecting...';
            statusDiv.style.color = 'orange';

            const socket = new SockJS('http://localhost:8080/ws');
            stompClient = Stomp.over(socket);

            stompClient.debug = (str) => console.log('STOMP DEBUG:', str);

            stompClient.connect({},
                (frame) => {
                    log('âœ… STOMP Connected through Gateway!', 'success');
                    statusDiv.textContent = 'Connected (via Gateway 8080)';
                    statusDiv.style.color = 'green';
                    log('Frame: ' + frame, 'info');
                },
                (error) => {
                    log('âŒ Connection error: ' + error, 'error');
                    statusDiv.textContent = 'Error';
                    statusDiv.style.color = 'red';
                }
            );
        }

        function subscribeToRoom() {
            const roomId = document.getElementById('roomId').value;
            if (!roomId) {
                alert('Please enter a room ID');
                return;
            }

            if (!stompClient || !stompClient.connected) {
                alert('Not connected!');
                return;
            }

            if (currentSubscription) {
                log('ðŸ”• Unsubscribing from previous room', 'info');
                currentSubscription.unsubscribe();
            }

            const destination = `/topic/room.${roomId}`;
            log(`ðŸ”” Subscribing to ${destination}`, 'info');

            currentSubscription = stompClient.subscribe(destination, (message) => {
                log('ðŸ“¨ Received message!', 'success');
                log('Raw: ' + message.body, 'info');
                try {
                    const msg = JSON.parse(message.body);
                    log('Parsed message:', 'success');
                    log(JSON.stringify(msg, null, 2), 'info');
                } catch (e) {
                    log('âŒ Failed to parse message: ' + e, 'error');
                }
            });

            log('âœ… Subscribed successfully to ' + destination, 'success');
        }

        function sendMessage() {
            const roomId = document.getElementById('roomId').value;
            const messageText = document.getElementById('message').value;

            if (!roomId || !messageText) {
                alert('Please enter room ID and message');
                return;
            }

            if (!stompClient || !stompClient.connected) {
                alert('Not connected!');
                return;
            }

            const testMessage = {
                senderId: 'test-user-' + Math.random().toString(36).substr(2, 9),
                senderUsername: 'Test User',
                receiverId: 'other-user',
                content: messageText,
                chatRoomId: roomId,
                type: 'CHAT',
                timestamp: new Date().toISOString(),
                status: 'SENT'
            };

            log('ðŸ“¤ Sending message to /app/chat.sendMessage', 'info');
            log(JSON.stringify(testMessage, null, 2), 'info');

            stompClient.send('/app/chat.sendMessage', {}, JSON.stringify(testMessage));

            log('âœ… Message sent!', 'success');
        }

        window.onload = () => {
            log('ðŸš€ Page loaded, connecting...', 'info');
            connect();
        };
    </script>
</body>

</html>