<!DOCTYPE html>
<html>
<head>
    <title>Service Status Check (Fixed)</title>
    <style>
        .status { padding: 10px; margin: 5px; border-radius: 5px; }
        .up { background: #d4edda; color: #155724; }
        .down { background: #f8d7da; color: #721c24; }
        .testing { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>Service Status Check (Fixed Routes)</h1>
    
    <div id="services">
        <div class="status testing">Checking services...</div>
    </div>

    <button onclick="testAuthAPI()">Test Auth API</button>
    <button onclick="testChatAPI()">Test Chat API</button>
    <button onclick="testWebSocket()">Test WebSocket</button>

    <div id="results" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;"></div>

    <script>
        const GATEWAY_URL = 'http://localhost:8080';

        const services = [
            { name: 'API Gateway', url: `${GATEWAY_URL}/actuator/health` },
            { name: 'Auth Service', url: `${GATEWAY_URL}/auth/health` },
            { name: 'Chat Service', url: `${GATEWAY_URL}/chat/health` }
        ];

        async function checkService(service) {
            try {
                const response = await fetch(service.url);
                if (response.ok) {
                    const data = await response.json();
                    return data.status === 'UP' || response.status === 200;
                }
                return false;
            } catch (error) {
                console.log(`Error checking ${service.name}:`, error);
                return false;
            }
        }

        async function checkAllServices() {
            const container = document.getElementById('services');
            container.innerHTML = '';
            
            for (const service of services) {
                const statusDiv = document.createElement('div');
                statusDiv.className = 'status testing';
                statusDiv.textContent = `${service.name}: Checking...`;
                container.appendChild(statusDiv);
                
                const isUp = await checkService(service);
                statusDiv.className = `status ${isUp ? 'up' : 'down'}`;
                statusDiv.textContent = `${service.name}: ${isUp ? '✅ UP' : '❌ DOWN'}`;
            }
        }

        async function testAuthAPI() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="status testing">Testing Auth API...</div>';
            
            try {
                const registerData = {
                    username: 'testuser_' + Date.now(),
                    email: 'test' + Date.now() + '@example.com',
                    password: 'password123',
                    firstName: 'Test',
                    lastName: 'User'
                };

                const response = await fetch(`${GATEWAY_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(registerData)
                });

                const data = await response.json();
                
                if (response.ok) {
                    results.innerHTML = `<div class="up">✅ Auth API Working! Registered user: ${data.username}</div>`;
                } else {
                    results.innerHTML = `<div class="down">❌ Auth Registration Failed: ${data.error || 'Unknown error'}</div>`;
                }
            } catch (error) {
                results.innerHTML = `<div class="down">❌ Auth API Error: ${error.message}</div>`;
            }
        }

        async function testChatAPI() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="status testing">Testing Chat API...</div>';
            
            try {
                const response = await fetch(`${GATEWAY_URL}/api/chat/test`);
                const text = await response.text();
                
                if (response.ok) {
                    results.innerHTML = `<div class="up">✅ Chat API Working! ${text}</div>`;
                } else {
                    results.innerHTML = `<div class="down">❌ Chat API Failed: ${text}</div>`;
                }
            } catch (error) {
                results.innerHTML = `<div class="down">❌ Chat API Error: ${error.message}</div>`;
            }
        }

        function testWebSocket() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="status testing">Testing WebSocket...</div>';
            
            try {
                const socket = new WebSocket('ws://localhost:8080/ws');
                
                socket.onopen = function(event) {
                    results.innerHTML = `<div class="up">✅ WebSocket Connected!</div>`;
                    socket.close();
                    results.innerHTML += `<div class="up">✅ WebSocket Test Completed!</div>`;
                };

                socket.onerror = function(error) {
                    results.innerHTML = `<div class="down">❌ WebSocket Error</div>`;
                };

            } catch (error) {
                results.innerHTML = `<div class="down">❌ WebSocket Error: ${error.message}</div>`;
            }
        }

        // Check services
        checkAllServices();
        setInterval(checkAllServices, 10000);
    </script>
</body>
</html>